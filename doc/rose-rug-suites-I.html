<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Rose User Guide: Suites I</title>
  <meta name="author" content="Rose Team, Met Office, UK" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="defaultView" content="outline" />
  <meta name="controlVis" content="visible" />
  <link rel="stylesheet" href="S5/slides.css" type="text/css" media=
  "projection" id="slideProj" />
  <link rel="stylesheet" href="S5/outline-rose.css" type="text/css" media=
  "screen" id="outlineStyle" />
  <link rel="stylesheet" href="S5/opera.css" type="text/css" media="projection"
  id="operaFix" />
  <link rel="stylesheet" type="text/css" href=
  "google-code-prettify/prettify.css" />
  <link rel="icon" href="rose-icon.png" type="image/png" />
  <link rel="shortcut icon" href="rose-icon.png" type="image/png" />
  <script src="S5/slides.js" type="text/javascript">
</script>
  <script type="text/javascript" src="jquery.min.js">
</script>
  <script type="text/javascript" src="google-code-prettify/prettify.js">
</script>
  <script type="text/javascript" src="prettify-rose-conf.js">
</script>
  <script type="text/javascript" src="prettify-cylc-suite-rc.js">
</script>
  <script type="text/javascript" src="rose-doc.js">
</script>
  <script type="text/javascript" src="rose-version.js">
</script>
</head>

<body>
  <div class="header-footer" id="body-header">
    <address>
      &copy; British Crown Copyright 2012-5 <a href=
      "http://www.metoffice.gov.uk">Met Office</a>. See <a href=
      "rose-terms-of-use.html">Terms of Use</a>.<br />
      This document is released under the <a href=
      "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
      "license">Open Government Licence</a>.<br />
      <span id="rose-version"></span>
    </address>

    <div class="rose-link">
      <img id="rose-icon" src="rose-icon.png" alt="Rose" />

      <p><a id="doc-home-link" href="." name="doc-home-link">Rose
      Documentation</a></p>
    </div>

    <div id="currentSlide">
      <!-- DO NOT EDIT -->
    </div>

    <div id="controls">
      <!-- DO NOT EDIT -->
    </div>

    <div class="header-footer" id="footer"></div>
  </div>

  <div id="body-main" class="presentation">
    <div class="slide">
      <h1>Rose User Guide: Suites I</h1>
    </div>

    <div class="handout" id="content"></div>

    <div class="slide">
      <h2 id="intro">Introduction</h2>

      <p>What is this?</p>

      <ul class="incremental">
        <li>This is guide material for developing and using Rose suites under
        cylc.</li>

        <li>A Rose suite is a collection of scientific task configurations (or
        'applications') with a <q>common purpose</q><!-- (Hilary) -->.</li>

        <li>cylc is a suite engine that drives task submission and
        monitoring.</li>
      </ul>
    </div>

    <div class="slide">
      <h3>That's too abstract - what's cylc again?</h3>

      <ul class="incremental">
        <li>cylc makes your Rose stuff happen.</li>
      </ul>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">What does this cover?</h3>

      <p>What does this cover?</p>

      <ul class="incremental">
        <li>cylc background and philosophy</li>

        <li>cylc basic usage</li>

        <li>basic suite design</li>
      </ul>
    </div>

    <div class="slide">
      <h3 id="intro-disclaimer">Disclaimer</h3>

      <p>The best reference for cylc is the <a href=
      "http://cylc.github.io/cylc/html/single/cug-html.html">cylc User
      Guide</a> - some of the following images are taken from there.</p>
    </div>

    <div class="slide">
    <h2 id="background">Background</h2>

    <p class="caption">Original name inspiration:</p><img src=
    "http://upload.wikimedia.org/wikipedia/en/1/1e/Cylon_Centurion.png" alt=
    "Battlestar Galactica Cylon (re-imagined)" /></div>

    <div class="slide">
      <h3 class="alwayshidden">Background - NIWA</h3>

      <p>cylc was originally developed by <a href=
      "https://github.com/hjoliver">Hilary Oliver</a> at <a href=
      "http://www.niwa.co.nz/">NIWA</a>. It runs their <a href=
      "http://ecoconnect.niwa.co.nz/">EcoConnect</a> operational
      suite.</p><img src=
      "http://cylc.github.io/cylc/graphics/png/scaled/niwa-colour-small.png"
      alt="NIWA logo" />

      <p>cylc was developed to provide a fast, automated way of scheduling
      tasks so that a suite could <em>catch up</em> after outages.</p>
    </div>

    <div class="slide">
    <h3>Background - ECOX</h3><img src=
    "http://cylc.github.io/cylc/screenshots/ecox-1.png"
    alt="ECOX" width="80%" /></div>

    <div class="slide">
      <h3>Background - Current</h3>

      <p>cylc is now a collaborative effort, involving the Met Office.</p>

      <p>cylc is written in <a href="www.python.org">Python</a> and uses
      <a href="www.pygtk.org">PyGTK</a> for its GUIs. It is open source and
      licensed under <a href="http://www.gnu.org/licenses/gpl.html">GPL
      v3</a>.</p>

      <p>cylc lives on <a href="http://github.com/cylc/">github</a>.</p>
    </div>

    <div class="slide">
      <h2 id="algorithm">Scheduling Algorithm</h2>

      <p>Scheduling - making sure tasks run in the correct order, at the
      correct time - is the core purpose of cylc. The <a href=
      "http://cylc.github.io/cylc/html/single/cug-html.html#x1-70001.4">cylc
      scheduling algorithm</a> is very simple, and very powerful:</p>

      <ul class="incremental">
        <li>Every task has input and output dependencies.</li>

        <li>Each task checks the others to see if its inputs are satisfied - if
        so, it runs.</li>
      </ul>
    </div>

    <div class="slide">
    <h3 class="alwayshidden">Single Cycle</h3>

    <p>Task dependencies - single cycle</p><img src=
    "http://cylc.github.io/cylc/graphics/png/scaled/dep-one-cycle.png" width=
    "40%" alt="single cycle dependencies" /></div>

    <div class="slide">
    <h3 class="alwayshidden">Scheduling Cycling Tasks</h3>

    <p>Most meteorological suites repeat over time (cycling):</p><img src=
    "http://cylc.github.io/cylc/graphics/png/scaled/dep-multi-cycle.png" width=
    "40%" alt="multi-cycle dependencies" /></div>

    <div class="slide">
    <h3 class="alwayshidden">A Cycle isn't A Prison</h3>

    <p>A cycle isn't a prison - if tasks can run ahead of their cycle time,
    they should. The image shows how a traditional cycle-fixed scheduler
    operates (bottom) vs cylc (top).</p><img src=
    "http://cylc.github.io/cylc/graphics/png/scaled/timeline-two.png" width=
    "50%" alt="optimal task scheduling" /></div>

    <div class="slide">
      <h2 id="suite-rc">The suite.rc File</h2>

      <p>cylc has a single file to configure the suite, the
      <samp>suite.rc</samp> file. It configures:</p>

      <ul class="incremental">
        <li>Task dependencies, including times and dates</li>

        <li>Task environment</li>

        <li>Task scripting</li>
      </ul>
    </div>

    <div class="slide">
      <h3 id="suite-rc-format">Format</h3>

      <p>cylc uses a nested INI-based configuration format that looks like
      this:</p>
      <pre class="prettyprint lang-cylc">
[scheduling]                     # Scheduling section
    [[dependencies]]             # Dependencies sub-section
        graph = my_task          # Graph Setting, option = value
[runtime]                        # Runtime Section
    [[my_task]]                  # User-specified task sub-section
        [[[environment]]]        # Environment sub-sub-section
            FOO = bar            # User-specified, option = value
</pre>
    </div>

    <div class="slide">
      <h2 id="hello-world">Hello World cylc suite</h2>

      <p>A simple cylc suite has a single <samp>suite.rc</samp> file that looks
      like this:</p>
      <pre class="prettyprint lang-cylc">
[scheduling]
    [[dependencies]]
        graph = hello_world
[runtime]
    [[hello_world]]
        script = echo 'Hello World'
</pre>

      <p>This will run a cylc task called <samp>hello_world</samp> that prints
      <samp>Hello World</samp> to standard out.</p>
    </div>

    <div class="slide">
      <h3 id="hello-world-demo">Demoing the Hello World cylc suite</h3>

      <p>Demo this by creating and running the simple cylc suite:</p>
      <pre class="prettyprint lang_sh">
mkdir $TMPDIR/simplesuite  # Make the suite directory
touch $TMPDIR/simplesuite/rose-suite.conf  # Rose needs a rose-suite.conf
cat &gt;$TMPDIR/simplesuite/suite.rc &lt;&lt;__SUITE_RC__
[scheduling]
    [[dependencies]]
        graph = hello_world
[runtime]
    [[hello_world]]
        script = echo 'Hello World'
__SUITE_RC__
rose suite-run -C $TMPDIR/simplesuite   # Run the suite!
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Demo Output</h3>

      <p>As we saw before, the suite will run and shutdown when all tasks are
      successful - in this case, the only task is <samp>hello_world</samp>.</p>

      <p>The suite output will be in our <samp>cylc-run</samp> directory, which
      you can also access by running <samp>rose suite-log
      --name=simplesuite</samp>.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Hello World Rose Suite</h3>

      <p>Tasks such as our <samp>hello_world</samp> task above are generic -
      they can be Rose applications, or commands or executables as above.</p>

      <p>If we wanted to invoke a Rose application, we'd make an app called
      <samp>hello_world</samp>, by making an <samp>app/hello_world/</samp>
      directory and creating a <samp>rose-app.conf</samp> file in there with
      this content:</p>
      <pre class="prettyprint lang-rose_conf">
[command]
default=echo 'Hello World'
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Hello World rose task-run Example</h3>

      <p>We would then have to change the <samp>[runtime]</samp> section
      to:</p>
      <pre class="prettyprint lang-cylc">
[runtime]
    [[hello_world]]
        script = rose task-run
</pre>

      <p><code>rose task-run</code> uses environment variables passed in by
      cylc (like <var>CYLC_TASK_NAME</var>) to figure out which Rose
      application to run. In this case, it'll be
      <samp>app/hello_world</samp></p>
    </div>

    <div class="slide">
      <h2 id="task-run">Hello World rose task-run</h2>

      <p><code>rose task-run</code> is reasonably generic, so we can put it as
      the suite default (<samp>[[root]]</samp>)<samp>script</samp>
      by writing:</p>
      <pre class="prettyprint lang-cylc">
[runtime]
    [[root]]
        script = rose task-run
    [[hello_world]]
</pre>

      <p><samp>[[root]]</samp> contains default settings that all cylc tasks
      inherit from. It is a special case of a cylc <code>family</code>.
      Families contain shared settings for one or more tasks.</p>
    </div>

    <div class="slide">
      <h2 id="families">Families</h2>

      <p>Families define shared configuration.</p>

      <p>Families can be used to reduce duplication between tasks.</p>

      <p>Overriding family settings is possible.</p>

      <p>Multiple inheritance.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Families (2)</h3>

      <p>Families can also be used to help write the dependencies - e.g. to set
      up a task so that it runs when all the tasks in a family succeed (more
      later). They can also be used in <a href=
      "rose-rug-advanced-tutorials-queues.html">queues</a>.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Families Example</h3>

      <p>Here is a <samp>suite.rc</samp> <samp>[runtime]</samp> section snippet
      for a suite with two similar applications, <samp>hello_eris/</samp> and
      <samp>hello_pluto/</samp></p>
      <pre class="prettyprint lang-cylc">
[runtime]
    [[root]]
        script = rose task-run
    [[HELLO_FAMILY]]
        [[[environment]]]
            IS_WORLD_A_PLANET = false # Shared env variable
    [[hello_eris]]
        inherit = HELLO_FAMILY
    [[hello_pluto]]
        inherit = HELLO_FAMILY
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Families and Overrides</h3>

      <p>Overriding family settings can be done under a task section:</p>
      <pre class="prettyprint lang-cylc">
[runtime]
    [[root]]
        script = rose task-run
    [[HELLO_FAMILY]]
        [[[environment]]]
            IS_WORLD_A_PLANET = false  # Shared env variable
    [[hello_eris]]
        inherit = HELLO_FAMILY
    [[hello_pluto]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            IS_WORLD_A_PLANET = true  # Override.
</pre>
    </div>

    <div class="slide">
      <h2 id="shared-applications">Shared Applications</h2>

      <p>In the last example, if we don't really need two Rose applications,
      (<samp>app/hello_eris/</samp> and <samp>app/hello_pluto/</samp>) we can
      create two tasks that share a single application, with some override
      settings - in this example, a <var>WORLD</var> environment variable.</p>

      <p>We can reference our single application, <samp>app/hello_world/</samp>
      by using <var>ROSE_TASK_APP</var>. <code>rose task-run</code> will read
      this environment variable value and use it to run the Rose app. We will
      put the override setting (<var>WORLD</var>) in the <samp>suite.rc</samp>
      file.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Shared Applications Example</h3>
      <pre class="prettyprint lang-cylc">
[runtime]
    [[root]]
        script = rose task-run
    [[HELLO_FAMILY]]
        [[[environment]]]
            IS_WORLD_A_PLANET = false  # Shared env variable
            ROSE_TASK_APP = hello_world
    [[hello_eris]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = eris
    [[hello_pluto]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = pluto
</pre>
    </div>

    <div class="slide">
      <h2 id="multiple-inheritance">Multiple Family Inheritance</h2>

      <p>cylc supports multiple inheritance, so tasks can combine useful
      configuration from more than one separate family. If you set up families
      like this:</p>
      <pre class="prettyprint lang-cylc">
    [[HELLO_FAMILY]]
        [[[environment]]]
            ROSE_TASK_APP = hello_world
    [[GAS_GIANT_FAMILY]]
        [[[environment]]]
            ATMOSPHERE_ONLY = true
    [[ROCKY_FAMILY]]
        [[[environment]]]
            ATMOSPHERE_ONLY = false
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Multiple Family Inheritance (2)</h3>

      <p>You can inherit them like this:</p>
      <pre class="prettyprint lang-cylc">
    [[hello_neptune]]
        inherit = HELLO_FAMILY, GAS_GIANT_FAMILY
        [[[environment]]]
            WORLD = neptune
</pre>

      <div class="slide">
        <h2 id="remote-hosts">Remote Hosts</h2>

        <p>So far, the example tasks run on the localhost - it is usually
        better to farm off tasks to a remote host like a compute server or a
        cluster/supercomputer.</p>

        <p>We could set <samp>hello_eris</samp> to run on a given host by
        setting <samp>[[[remote]]]</samp> section settings:</p>
        <pre class="prettyprint lang-cylc">
    [[hello_eris]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = eris
        [[[remote]]]
            host = voyager_1
</pre>
      </div>

      <p>The order in which they are combined is essentially last to first -
      e.g. <samp>HELLO_FAMILY</samp> will override any shared setting in
      <samp>GAS_GIANT_FAMILY</samp>.</p>
    </div>

    <div class="slide">
      <h2 id="dependencies">Dependencies</h2>

      <p>We haven't looked at the <samp>[scheduling]</samp> part of the
      suite.rc yet.</p>

      <p>Let's say <samp>hello_pluto</samp> must run and succeed before
      <samp>hello_eris</samp>. We can put this in our
      <samp>suite.rc</samp>:</p>
      <pre class="prettyprint lang-cylc">
[scheduling]
    [[dependencies]]
        graph = hello_pluto =&gt; hello_eris
</pre>
    </div>

    <div class="slide">
      <h3 id="dependencies-cycling">Cycling Dependencies</h3>

      <p>We can make this run as a cycling suite, repeating every 12 hours:</p>
      <pre class="prettyprint lang-cylc">
[scheduling]
    initial cycle point = 20130105T00Z  # 00:00, 5/1/2013
    final cycle point = 20130106T00Z    # 00:00, 6/1/2013
    [[dependencies]]
        [[[T00, T12]]]  # run each day at 00:00 and 12:00
            graph = hello_pluto =&gt; hello_eris
</pre>
    </div>

    <div class="slide">
      <h2 id="jinja2">Jinja2</h2>

      <p>cylc uses a templating language called Jinja2 that you can use to
      collapse duplicated portions of configuration or insert settings.</p>

      <p>This means that you can embed special instruction code in the
      <samp>suite.rc</samp> file to generate or insert text that will be
      expanded at runtime.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Jinja2 Loop</h3>

      <p>This can be especially useful when you have a lot of repetition - for
      example, in an ensemble context. You can use <code>if</code> and
      <code>for</code> blocks, amongst other things:</p>
      <pre class="prettyprint lang-cylc">
{%- for WORLD in ["eris", "pluto", "makemake", "haumea"] %}
    [[hello_{{ WORLD }}]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = {{ WORLD }}
{%- endfor %}
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Jinja2 Result</h3>

      <p>This gets processed at runtime, so the file as read in by cylc looks
      like:</p>
      <pre class="prettyprint lang-cylc">
    [[hello_eris]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = eris
    [[hello_pluto]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = pluto
    [[hello_makemake]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = makemake
    [[hello_haumea]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = haumea
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Jinja2 rose-suite.conf</h3>

      <p>You can use Jinja2 to centralise commonly-used settings. Rose supports
      storing these in the <samp>rose-suite.conf</samp> file - e.g.</p>
      <pre class="prettyprint lang-rose_conf">
[jinja2:suite.rc]
HELLO_WORLDS = ["eris", "pluto", "makemake", "haumea"]
</pre>

      <p>Rose passes variables in this section into the Jinja2 template at
      runtime. This means that we can have a <samp>suite.rc</samp> snippet that
      looks like this:</p>
      <pre class="prettyprint lang-cylc">
{%- for WORLD in HELLO_WORLDS %}
    [[hello_{{ WORLD }}]]
        inherit = HELLO_FAMILY
        [[[environment]]]
            WORLD = {{ WORLD }}
{%- endfor %}
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Jinja2 rose-suite.conf Advantages</h3>

      <p>It's useful to keep commonly-changed variables in the
      <samp>rose-suite.conf</samp> file, so users don't have to modify the
      <samp>suite.rc</samp> itself.</p>

      <p>You can also add proper metadata for them such as help, so they have a
      nice interface in the config editor.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Jinja2 rose-suite.conf Setting Example</h3>

      <p>For example, if we had a <samp>suite.rc</samp> setting that looked
      like this:</p>
      <pre class="prettyprint lang-cylc">
        [[[environment]]]
            INCLUDE_MOONS = {{ HELLO_TO_MOONS }}
</pre>

      <p>We could have a <samp>rose-suite.conf</samp> file that looked like
      this:</p>
      <pre class="prettyprint lang-rose_conf">
[jinja2:suite.rc]
HELLO_TO_MOONS=false
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Jinja2 rose-suite.conf Metadata Example</h3>

      <p>We could then write some nice metadata (similar to app metadata) for
      the <samp>rose-suite.conf</samp> file, such as:</p>
      <pre class="prettyprint lang-rose_conf">
[jinja2:suite.rc=HELLO_TO_MOONS]
help=Decide whether to say hello to the moons of the world
    =(if any).
    =
    =If true, include moons like
    =http://en.wikipedia.org/wiki/Dysnomia_%28moon%29
    =If false, ignore them.
    =
    =Moons of moons are not supported.
title=Include Moons when saying hello?
type=boolean
</pre>
    </div>

    <div class="slide">
      <h2 id="utc-mode">UTC mode</h2>

      <p>We recommend running all suites in UTC mode. E.g.:</p>
      <pre class="prettyprint lang-cylc">
[cylc]
    UTC mode = True # Ignore DST
</pre>
    </div>

    <div class="slide">
      <h2 id="event-hooks">Event Hooks</h2>

      <p>Suites can have event handlers to report events or shutdown on
      failure.</p>

      <pre class="prettyprint lang-cylc">
[cylc]
    UTC mode = True # Ignore DST
    # abort if any task fails = True
    [[event hooks]]
        # timeout handler = rose suite-hook --mail --shutdown
        # timeout = P3D
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Event Hooks Explained</h3>

      <p>Normally, when a task fails, the suite will continue to run as much as
      possible and wait for user input to fix (and perhaps retry) the failure so
      it can continue. If <code>abort if any task fails = True</code> is not
      commented out, the suite will abort as soon as a task fails.</p>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Hello World Event Hooks (Continued)</h3>

      <p>Suites can also be configured to email you on specific events. For
      example:</p>
      <pre class="prettyprint lang-cylc">
[runtime]
    [[root]]
        [[[events]]]
            mail events = submission retry, retry, \
                          submission failed, failed, \
                          submission timeout, execution timeout
</pre>

      <p>The events should be adjusted if necessary - for example, increasing
      the timeout lengths or altering the events that require email
      notification.</p>
    </div>

    <div class="slide">
      <h2 id="submit">Job Submission</h2>

      <p>We may want to configure a job submission method, such as using
      <code>LoadLeveler</code> (spelling is theirs):</p>
      <pre class="prettyprint lang-cylc">
    [[hello_eris]]
...
        [[[job submission]]]
            method = pbs
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Directives</h3>

      <p>The job submission method may need configuration via
      <code>directives</code>:</p>
      <pre class="prettyprint lang-cylc">
    [[hello_eris]]
...
        [[[job submission]]]
            method = pbs
        [[[directives]]]
            -l select = 1
            -l walltime = 00:05:00
            -q = normal
</pre>
    </div>

    <div class="slide">
      <h3 class="alwayshidden">Job Submission Methods</h3>

      <p>cylc supports the following job submission methods (and more):</p>

      <ul class="incremental">
        <li>at</li>

        <li>background (default)</li>

        <li>loadleveler</li>

        <li>pbs (Portable Batch System)</li>

        <li>sge (<del>Sun</del> Oracle Grid Engine)
        </li>

        <li>slurm (not the fictional soft drink)</li>

        <li>lsf</li>
      </ul>
    </div>

    <div class="slide">
      <h2 id="independent">Independent Learning</h2>

      <p>Next Steps:</p>

      <ul>
        <li>Go through the <a href="rose-rug-suite-writing-tutorial.html">Suite
        Writing Tutorial</a>.</li>

        <li>If you have time, look at some of the <a href=
        "rose.html#advanced">Advanced Suite Tutorials</a>.</li>

        <li>Move on to <a href="rose-rug-suites-II.html">Suites II</a>.</li>
      </ul>
    </div>
  </div>
</body>
</html>
