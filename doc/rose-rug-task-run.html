<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Rose User Guide: Running Tasks</title>
  <meta name="author" content="Rose Team, Met Office, UK" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <link rel="icon" href="rose-icon.png" type="image/png" />
  <link rel="shortcut icon" href="rose-icon.png" type="image/png" />
  <link rel="stylesheet" type="text/css" href="rose-doc.css" />
  <link rel="stylesheet" type="text/css" href=
  "google-code-prettify/prettify.css" />
  <script type="text/javascript" src="jquery.min.js">
</script>
  <script type="text/javascript" src="google-code-prettify/prettify.js">
</script>
  <script type="text/javascript" src="prettify-rose-conf.js">
</script>
  <script type="text/javascript" src="rose-doc.js">
</script>
  <script type="text/javascript" src="rose-version.js">
</script>
</head>

<body>
  <div class="header-footer" id="body-header">
    <address>
      &copy; British Crown Copyright 2012-5 <a href=
      "http://www.metoffice.gov.uk">Met Office</a>. See <a href=
      "rose-terms-of-use.html">Terms of Use</a>.<br />
      This document is released under the <a href=
      "http://www.nationalarchives.gov.uk/doc/open-government-licence/" rel=
      "license">Open Government Licence</a>.<br />
      <span id="rose-version"></span>
    </address>

    <div class="rose-link">
      <img id="rose-icon" src="rose-icon.png" alt="Rose" />

      <p><a id="doc-home-link" href="." name="doc-home-link">Rose
      Documentation</a></p>
    </div>
  </div>

  <div id="body-main">
    <h1>Rose User Guide: Running Tasks</h1>

    <div id="content"></div>

    <h2 id="intro">Introduction</h2>

    <p>This chapter of the user guide discusses the Rose suite tools and
    utilities that can be used to simplify the logic of a suite and/or provide
    a common approach of doing the same things.</p>

    <h2 id="rose-task-run">rose task-run</h2>

    <p>The <code>rose task-run</code> command selects and launches an
    application (according to an application configuration) under the
    environment of a job (of a task) in a suite.</p>

    <p>See <a href="rose-command.html#rose-task-run">Rose Reference Guide: CLI
    &gt; rose task-run</a> for a full command reference.</p>

    <p>See <a href="rose-configuration.html#format">Rose Reference Guide:
    Configuration &gt; Configuration Format</a> for more information on the
    Rose configuration format.</p>

    <p>See <a href="rose-configuration.html#app">Rose Reference Guide:
    Configuration &gt; Application Configuration</a> for more information on
    how to set up a Rose application configuration.</p>

    <h3 id="rose-task-run.work-dir">Working Directory</h3>

    <p>The working directory of a task is dependent on the suite engine. For a
    task running under cylc, the working directory of a task is normally
    <var>$ROSE_SUITE_DIR/work/$ROSE_TASK_CYCLE_TIME/$ROSE_TASK_NAME/</var>, (or
    <var>$ROSE_SUITE_DIR/work/1/$ROSE_TASK_NAME/</var> for a non-cycling
    task.)</p>

    <p>The <code>rose task-run</code> (or the <code>rose app-run</code>)
    command also dumps out a <var>rose-app-run.conf</var> file in the working
    directory. The file contains the original <var>rose-app.conf</var> in the
    application configuration with any added optional configurations and
    command line settings set via
    <code>--define=[SECTION]NAME=VALUE</code>.</p>

    <h3 id="rose-task-run.app">Application Configuration Selection</h3>

    <p>The <code>rose task-run</code> command selects its application
    configuration in the following order:</p>

    <ol>
      <li>If the <code>--config=DIR</code> option is specified, it uses the
      value of <var>DIR</var> as the path to the application configuration
      directory.</li>

      <li>If the <code>--app-key=KEY</code> option is specified, it uses the
      <var>KEY</var> sub-directory under the suite's <var>app/</var> directory
      as the application configuration directory.</li>

      <li>If the <var>ROSE_TASK_APP=KEY</var> environment variable is
      specified, it uses the <var>KEY</var> sub-directory under the suite's
      <var>app/</var> directory as the application configuration
      directory.</li>

      <li>Finally, it looks at the suite's <var>app/</var> directory for an
      application configuration directory that matches the name of the task.
      (The command fails if it is unable to locate an application
      configuration.)</li>
    </ol>

    <h3 id="rose-task-run.env">Environment Variables Export</h3>

    <p>The <code>rose task-run</code> command exports a set of
    <var>ROSE_*</var> environment variables to its environment before doing
    anything. The list is documented in <a href=
    "rose-command.html#rose-task-env">Rose Reference Guide: CLI &gt; rose
    task-env</a>.</p>

    <p>The <code>rose task-run</code> command also sets up the <var>PATH</var>
    environment variable and if relevant, other PATH-like environment
    variables, (e.g. <var>PYTHONPATH</var>). The following logic is applied in
    order:</p>

    <ol>
      <li>The command looks for <var>[rose-task-run]path-prepend.NAME</var>
      settings in the site/user configuration files, where <var>NAME</var> is
      <var>PATH</var> or the name of a PATH-like variable. (The
      <var>[rose-task-run]path-prepend</var> setting can be used as a shorthand
      for <var>[rose-task-run]path-prepend.PATH</var>.) The values of these
      settings are expected to be space delimited lists of directory paths. For
      each directory path, the command will check that it exists before
      prepending it to relevant environment variable. E.g.:
        <pre class="prettyprint lang-rose_conf">
[rose-task-run]
# Prepend /opt/hello/bin /opt/greeting/bin to $PATH
path-prepend=/opt/hello/bin /opt/greeting/bin
# Prepend /opt/stuff/lib/perl to $PERL5LIB
path-prepend.PERL5LIB=/opt/stuff/lib/perl
</pre>
      </li>

      <li>The command looks for directories under <var>$ROSE_SUITE_DIR</var>
      that match the glob patterns <code>share/fcm[_-]make*/*/bin</code>,
      <code>work/fcm[_-]make*/*/bin</code>. Matched directories are added to
      the <var>PATH</var> environment variable.</li>

      <li>The command accepts one or more <code>--path=[NAME=]PATTERN</code>
      command line option. Each of these specify a glob pattern for paths to
      prepend to an environment variable called <var>NAME</var> (or
      <var>PATH</var> if <var>NAME</var> is not specified). If a relative path
      is given, it is relative to <var>$ROSE_SUITE_DIR</var>. An empty value
      resets anything prepended in (1.) and (2.) above and any previous
      <code>--path=[NAME=]PATTERN</code> settings for the relevant environment
      variable.</li>
    </ol>

    <p>The <code>rose task-run</code> command (or the <code>rose app-run</code>
    command) also exports each environment variables in the <var>[env]</var>
    section in the application configuration file. N.B.:</p>

    <ul>
      <li>The environment variables are exported in no particular oder, so they
      should not reference one another.</li>

      <li><code>$NAME</code> and <code>${NAME}</code> syntax in values of the
      settings are substituted by the value of the environment variable
      <var>NAME</var>. The command does not support any other Unix shell
      variable substitution/manipulation syntax, nor does it support any Unix
      shell syntax for sub-shell command substitution. The command fails if
      <var>NAME</var> is not an environment variable. You can escape a
      substitution by adding a backslash in front of the syntax, e.g.
      <code>\$NAME</code> or <code>\${NAME}</code>.</li>
    </ul>

    <p>The following is an example of using environment variables:</p>
    <pre class="prettyprint lang-rose_conf">
[command]
default=echo "$HELLO $WORLDS"

[env]
HELLO=Greeting
WORLDS=Mars Jupiter Saturn
</pre>

    <p>Most other sections in the application configuration file, (e.g. the
    file installation sections and the application command) can reference the
    exported environment variables described above.</p>

    <p>Finally, if the application configuration has a <var>bin/</var>
    sub-directory, the <code>rose task-run</code> command (or the <code>rose
    app-run</code> command) will prepend its location in front of the
    <var>PATH</var> environment variable.</p>

    <h3 id="rose-task-run.file">File Installation</h3>

    <p>The <code>rose task-run</code> command (or the <code>rose app-run</code>
    command) can be configured to install files to the working directory or
    other locations in the suite. It does the following:</p>

    <ul>
      <li>Install items specified in the <var>[file:*]</var> sections of the
      <var>rose-app.conf</var> file. See <a href=
      "rose-configuration.html#appendix-file-creation-mode">Rose Reference
      Guide: Configuration &gt; Appendix: File Creation Mode</a> for
      detail.</li>

      <li>Copy any regular files under the <var>file/</var> sub-directory of
      the application configuration to the working directory.</li>
    </ul>

    <p>If the command for the application requires some pre-defined standard
    input, a file called <var>STDIN</var> can be installed in the working
    directory. When the command is invoked, the contents of the file will be
    piped to the standard input of the command.</p>

    <p>The <code>rose task-run</code> command (or the <code>rose app-run</code>
    command) caches file installation settings in the
    <var>.rose-config_processors-file.db</var> file in the working directory.
    This allows file installation to be <em>incremental</em>. If the task is
    run again, identical files will not have to be reinstalled.</p>

    <h3 id="rose-task-run.command">Command Selection</h3>

    <p>By default, the <code>rose task-run</code> command (or the <code>rose
    app-run</code> command) invokes a shell command. (Alternatively, the
    <code>rose task-run</code> command invokes a built-in application. See
    <a href="#rose-task-run.built-in-app">Built-in Applications Selection</a>
    for detail.) It uses the following logic to select a shell command to
    run:</p>

    <ol>
      <li>If arguments are supplied to <code>rose task-run</code>, the
      arguments are run as a shell command.</li>

      <li>If the <code>--command-key=KEY</code> option is specified, the
      command specified in the <var>[command]KEY</var> setting in the
      application configuration file is used.</li>

      <li>If the <var>[command]</var> section in the application configuration
      file has a key matching the task name, the command specified in this
      setting is used.</li>

      <li>Otherwise, the command specified in the <var>[command]default</var>
      setting is used.</li>
    </ol>

    <p>This mechanism allows, for example, similar tasks to share the same
    application configuration, if most of their differences can be defined at
    the command line.</p>

    <p>E.g.</p>
    <pre class="prettyprint lang-rose_conf">
[command]
default=echo Hello World
hello_earth=echo Hello Earth
greet_martians=echo Greeting Martians
</pre>

    <p>In the above example, if the command key is <samp>hello_earth</samp>,
    the application will echo <samp>Hello Earth</samp>. If the command key is
    not defined, but the task name is <samp>greet_martians</samp>, the
    application will echo <samp>Greeting Martians</samp>. For any other tasks
    using this application configuration and if the command key is not defined,
    it will echo <samp>Hello World</samp>.</p>

    <h3 id="rose-task-run.built-in-app">Built-in Applications Selection</h3>

    <p>Apart from running a shell command, the <code>rose task-run</code>
    command (or the <code>rose app-run</code> command) may be configured to
    call a built-in application. To use a built-in application, add the
    <kbd>mode=KEY</kbd> top level setting in the application configuration,
    where <var>KEY</var> is the name of a built-in application. (Each built-in
    application is discussed individually later in this chapter.)</p>

    <p>A built-in application would normally behave very much like running an
    external command. The key differences are normally that:</p>

    <ol>
      <li>A built-in application may use a different working directory to a
      Rose application.</li>

      <li>A built-in application will run some pre-defined commands or logic
      instead of a command defined in the application configuration.</li>
    </ol>

    <h3 id="rose-task-run.poll">Poll for Prerequisites</h3>

    <p>Prerequisites of a task should normally be defined at the suite level.
    However, there are times when it is more efficient to poll for a simple
    prerequisite before running a command. The <code>rose task-run</code>
    command (or the <code>rose app-run</code> command) provides a facility for
    tasks to poll for some prerequisites before running the application
    command. The facility supports 3 types of tests:</p>

    <ul>
      <li><dfn>Poll all files</dfn> This can be configured by adding the
      <var>[poll]all-files</var> setting in the application configuration file.
      The value of the setting is expected to be a list of space delimited list
      of items. Each item can be a file path or a file glob pattern. This test
      passes only if all items in the list exist. E.g. a list with <kbd>file1
      file2 file3*</kbd> means that <samp>file1</samp>, <samp>file2</samp>
      <strong>and</strong> any file matching the glob pattern
      <samp>file3*</samp> must exist for the test to pass.</li>

      <li><dfn>Poll any files</dfn> This can be configured by adding the
      <var>[poll]any-files</var> setting in the application configuration file,
      as above. This test passes if any item in the list exists. E.g. a list
      with <kbd>file1 file2 file3*</kbd> means that <samp>file1</samp>,
      <samp>file2</samp> <strong>or</strong> any file matching the glob pattern
      <samp>file3*</samp> must exist for the test to pass.</li>

      <li><dfn>Poll with a shell command</dfn> This can be configured by adding
      the <var>[poll]test</var> setting in the application configuration file.
      The value of the setting is expected to be a shell command. This test
      passes if the command returns a 0 (zero) return code.</li>
    </ul>

    <p>Normally, both <var>all-files</var> and <var>any-files</var> test for
    the existence of file paths. If this is not enough, you can specify a
    <var>[poll]file-test</var> setting to run a command on each file. E.g. if
    you want to test for the existence of a string in each file, you can
    do:</p>
    <pre class="prettyprint lang-rose_conf">
all-files=file1 file2
file-test=test -e {} &amp;&amp; grep -q 'hello' {}
</pre>

    <p>At runtime, any <code>{}</code> pattern in the above is replaced with
    the name of the file. The above example checks that both <samp>file1</samp>
    and <samp>file2</samp> exist and that they both contain the string
    <samp>hello</samp>.</p>

    <p>By default, tests will only be performed once. If a list of
    <var>delays</var> is added, the tests will be performed a number of times
    with delays between them. If the prerequisites are still not met after the
    number of delays, <code>rose task-run</code> will fail with a time out. The
    delays list is a comma-separated list. The syntax looks like
    <var>[R*][P]</var>, where <var>R</var> is the number of repeats,
    <var>P</var> is the ISO8601 date-time format syntax, see 
    <a href="wiki:http://en.wikipedia.org/wiki/ISO_8601">wikipedia entry</a>
    (last checked on 2015-05-29).  
    E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
# Default
delays=0

# Poll 1 minute after the runner begins, repeat every minute 10 times
delays=10*PT1M

# Poll when runner begins,
# repeat every 10 seconds 6 times,
# repeat every minute 60 times,
# repeat once after 1 hour,
# repeat once after 1 week, 2 days, 6 hours and 30 seconds
delays=0,6*PT10S,60*PT1M,PT1H,P1W2DT6H30S
</pre>

    <h2 id="rose-task-run.built-in-app.fcm_make">Built-in Application:
    fcm_make</h2>

    <p>The <code>fcm_make</code> built-in applications is provided for running
    <code>fcm make</code>.</p>

    <p>N.B.:</p>
    
    <ul>
      <li>If a task has a name that contains the string <var>fcm_make</var>,
      <code>rose task-run</code> will run this built-in application
      automatically.</li>

      <li>N.B. If a task has a name that contains the string
      <var>fcm_make2*</var> and it does not have its own application
      configuration, <code>rose task-run</code> will attempt to associate it
      with the corresponding <var>fcm_make*</var> application
      configuration.</li>

      <li>In the default setting, the <samp>bin/</samp> directories of builds
      will be prepended to the <var>PATH</var> environment variable by
      <code>rose task-env</code> and/or <code>rose task-run</code> commands run
      by subsequent tasks in the suite.</li>
    </ul>

    <p>The <code>fcm_make</code> application expects a file
    <var>file/fcm-make.cfg</var> in its application configuration. It runs
    <code>fcm make</code> using this configuration file.</p>

    <p>You can configure these applications with environment variables or
    settings in <var>rose-app.conf</var>. (Settings in <var>rose-app.conf</var>
    override their equivalent environment variables.)</p>

    <dl>
      <dt><kbd>args=ARG ...</kbd> or the environment variable
      <var>ROSE_TASK_OPTIONS</var></dt>

      <dd>This can be used to pass extra options and arguments to the <code>fcm
      make</code> command.</dd>

      <dt><kbd>dest-orig=PATH</kbd></dt>

      <dd>Specify the path to the destination of the original make. This is
      normally specified as a relative path under <var>$ROSE_SUITE_DIR/</var>.
      The default is <var>share/$ROSE_TASK_NAME</var>. If <code>rose
      task-run</code> is invoked in <code>--new</code> mode, the application
      will remove this directory before running <code>fcm make
      --new</code>.</dd>

      <dt><kbd>dest-cont=PATH</kbd></dt>

      <dd>Specify the path to the destination of the continuation make. This is
      normally specified as a relative path under <var>$ROSE_SUITE_DIR/</var>.
      The default is to use the same location as <var>dest-orig</var>. If
      <code>rose task-run</code> is invoked in <code>--new</code> mode, the
      application will remove this directory before running <code>fcm make
      --new</code>. (If this location is in the same physical location of the
      destination of the original make, you should only invoke <code>rose
      task-run --new</code> on the original make. Otherwise, contents generated
      by the original make will be wiped clean before the continuation make
      begins.)</dd>

      <dt><kbd>fast-dest-root-orig=PATH</kbd></dt>

      <dd>Specify the path to an existing location that can be used as a fast
      working directory for the original make. If this is specified, the
      <code>fcm make</code> command will be invoked in a temporary directory
      under this location before being copied back to the actual
      destination.</dd>

      <dt><kbd>fast-dest-root-cont=PATH</kbd></dt>

      <dd>Specify the path to an existing location that can be used as a fast
      working directory for the continuation make. If this is specified, the
      <code>fcm make</code> command will be invoked in a temporary directory
      under this location before being copied back to the actual
      destination.</dd>

      <dt><kbd>make-name-orig=NAME</kbd></dt>

      <dd>Specify the context name of the original make. The default is a null
      string. You can specify an alternate context name if this is undesirable.
      The <code>fcm make</code> command will be invoked with the
      <code>--name=NAME</code> option of <code>fcm make</code>.</dd>

      <dt><kbd>make-name-cont=NAME</kbd></dt>

      <dd>Specify the context name of the continuation make. If the default
      <code>fcm_make</code> &rarr; <code>fcm_make2</code> mapping is used, the
      context name of the continuation make will be set to <code>2</code>. You
      can specify an alternate context name if this is undesirable. The
      continuation command will be invoked with the <code>--name=NAME</code>
      option of <code>fcm make</code>.</dd>

      <dt><kbd>mirror-step=STEP-NAME</kbd></dt>

      <dd>Specify the name of the mirror step, if not <samp>mirror</samp>. The
      application will normally look for a matching task in the suite (e.g.
      <code>fcm_make</code> &rarr; <code>fcm_make2</code>) which will continue
      the <code>fcm make</code> command at a remote <var>HOST</var>. If such a
      task is found, it will add the configuration
      <var>mirror.target=HOST:cylc-run/$ROSE_SUITE_NAME/share/$ROSE_TASK_NAME</var>
      as an argument to the <code>fcm make</code> command to substitute the
      mirror target. To switch off this feature, set <var>STEP-NAME</var> to a
      null string, i.e. <kbd>mirror-step=</kbd>.</dd>

      <dt><kbd>opt.jobs=N</kbd> or the environment variable
      <var>ROSE_TASK_N_JOBS</var></dt>

      <dd>This can be used to control the number of processes <code>fcm
      make</code> would use in parallel. (default=4)</dd>

      <dt><kbd>orig-cont-map=ORIG-NAME:CONT-NAME</kbd></dt>

      <dd>This setting allows you to override the default <code>fcm_make</code>
      &rarr; <code>fcm_make2</code> mapping between the names of the original
      and the continuation tasks in the suite.</dd>

      <dt><kbd>use-pwd=true</kbd></dt>

      <dd>By default, the application changes the working directory to
      <var>$ROSE_SUITE_DIR/share/$ROSE_TASK_NAME</var>. This option will stop
      this, and the working directory is the normal working directory of the
      task.</dd>
    </dl>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
meta=fcm_make
mode=fcm_make
opt.jobs=8
</pre>

    <h2 id="rose-task-run.util.rose_ana">Built-in Application: rose_ana</h2>

    <p>This built-in application runs <code>rose-ana</code>, the Rose
    comparison engine. This compares files against each other using a
    configurable method and reports whether the files differ or not. It
    also writes the details of any comparisons to its own database in the
    suite's <code>log</code> directory (see the guide linked below for
    more details).</p>

    <p>In automatic selection mode, this built-in application will be invoked
    automatically if a task has a name that starts with
    <code>rose_ana*</code>.</p>

    <p>The built-in application will search the <code>comparisons</code>
    subdirectory of the Rose installation for built-in comparisons, and further
    directories to search can be specified in the <code>rose.conf</code> file
    using the <var>method-path</var> variable in the <var>[rose-ana]</var>
    section.</p>

    <p>See also <a href="rose-rug-stem.html#rose-ana">rose stem &gt; Comparing
    output with rose_ana</a>.</p>

    <h2 id="rose-task-run.util.rose_arch">Built-in Application: rose_arch</h2>

    <p>This built-in application provides a generic solution to configure site
    specific archiving of suite files. It is designed to work under <code>rose
    task-run</code>.</p>

    <p>In automatic selection mode, this built-in application will be invoked
    automatically if a task has a name that starts with
    <code>rose_arch*</code>.</p>

    <p>The application is normally configured in a <var>rose-app.conf</var>.
    Global settings may be specified in an <kbd>[arch]</kbd> section. Each
    archiving target will have its own <kbd>[arch:TARGET]</kbd> section for
    specific settings, where <var>TARGET</var> would be a URI to the archiving
    location on your site specific archiving system. Settings in a
    <kbd>[arch:TARGET]</kbd> section would override those in the global
    <kbd>[arch]</kbd> section for the given <var>TARGET</var>.</p>

    <p>A target is considered compulsory, i.e. it must have at least one source,
    unless it is specified with the syntax <kbd>[arch:(TARGET)]</kbd>. In which
    case, <var>TARGET</var> is considered optional. The application will skip an
    optional target that has no actual source.</p>

    <p>The application provides some useful functionalities:</p>

    <ul>
      <li>Incremental mode. Store the archive target settings, checksums of
      source files and the return code of archive command. In a retry, it would
      only redo targets that did not succeed in the previous attempts.</li>

      <li>Rename of source files.</li>

      <li>Tar-Gzip or Gzip source files before sending them to the
      archive.</li>
    </ul>

    <p>The following settings are accepted in <kbd>[arch]</kbd> and
    <kbd>[arch:TARGET]</kbd> sections:</p>

    <dl>
      <dt><kbd>command-format=FORMAT</kbd></dt>

      <dd>Compulsory. A Pythonic <code>printf</code> style format string to
      construct the archive command. It must contain the placeholders
      <var>%(sources)s</var> and <var>%(target)s</var> for substitution of the
      sources and the target respectively.</dd>

      <dt><kbd>compress=pax|tar|pax.gz|tar.gz|tgz|gz</kbd></dt>

      <dd>Optional. If specified, compress source files to the given scheme
      before sending them to the archive. If not specified, the compress scheme
      is automatically determined by the file extension of the target, if it
      matches one of the allowed values. For the <var>pax|tar</var> scheme, the
      sources will be placed in a TAR archive before being sent to the target.
      For the <var>pax.gz|tar.gz|tgz</var> scheme, the sources will be placed
      in a TAR-GZIP file before being sent to the target. For the <var>gz</var>
      scheme, each source file will be compressed by GZIP before being sent to
      the target.</dd>

      <dt><kbd>rename-format</kbd></dt>

      <dd>Optional. If specified, the source files will be renamed according to
      the specified format. The format string should be a Pythonic
      <code>printf</code> style format string. It may contain the placeholder
      <var>%(cycle)s</var> (for the current <var>$ROSE_TASK_CYCLE_TIME</var>,
      the placeholder <var>%(name)s</var> for the name of the file, and/or
      named placeholders that are generated by <kbd>rename-parser</kbd>.</dd>

      <dt><kbd>rename-parser</kbd></dt>

      <dd>Optional. Ignored if <kbd>rename-format</kbd> is not specified.
      Specify a regular expression to parse the name of a source. The regular
      expression should do named captures of strings from source file names,
      which can then be used to substitute named placeholders in the
      corresponding <kbd>rename-format</kbd>.</dd>

      <dt><kbd>source=NAME</kbd></dt>

      <dd>Compulsory for each <kbd>[arch:TARGET]</kbd> section. Specify a list
      of space delimited source file names and/or globs for matching source
      file names. (File names with space or quote characters can be escaped
      using quotes or backslashes, like in a shell.)  Paths, if not absolute
      (beginning with a <var>/</var>), are assumed to be relative to
      <var>$ROSE_SUITE_DIR</var> or to <var>$ROSE_SUITE_DIR/PREFIX</var> if
      <kbd>source-prefix=PREFIX</kbd> is specified. If a name or glob is given
      in a pair of brackets, e.g. <code>(hello-world.*)</code>, the source is
      considered optional and will not cause a failure if it does not match any
      source file names. However, a compulsory target that ends up with no
      matching source file will be considered a failure.</dd>

      <dt><kbd>source-edit-format=FORMAT</kbd></dt>

      <dd>Optional. A Pythonic <code>printf</code> style format string to
      construct a command to edit or modify the content of source files before
      archiving them. It must contain the placeholders <var>%(in)s</var> and
      <var>%(out)s</var> for substitution of the path to the source file and
      the path to the modified source file (which will be created in a
      temporary working directory).</dd>

      <dt><kbd>source-prefix=PREFIX</kbd></dt>

      <dd>Optional. Add a prefix to each value in a source declaration. A
      trailing slash should be added for a directory. Paths are assumed to be
      relative to <var>$ROSE_SUITE_DIR</var>. This setting serves 2 purposes.
      It provides a way to avoid typing the same thing repeatedly. It also
      modifies the name-spaces of the sources if the target is in a TAR or
      TAR-GZIP file. In the absence of this setting, the name of a source in a
      TAR or TAR-GZIP file is the path relative to <var>$ROSE_SUITE_DIR</var>.
      By specifying this setting, the source names in a TAR or TAR-GZIP file
      will be shortened by the prefix.</dd>

      <dt><kbd>target-prefix=PREFIX</kbd></dt>

      <dd>Optional. Add a prefix to each target declaration. This setting
      provides a way to avoid typing the same thing repeatedly. A trailing
      slash (or whatever is relevant for the archiving system) should be added
      for a directory.</dd>

      <dt><kbd>update-check=mtime+size|md5|sha1|...</kbd></dt>

      <dd>Optional. Specify the method for checking whether a source has changed
      since the previous run. If the value is <kbd>mtime+size</kbd>, the
      application will use the modified time and size of the source, which is
      useful for large files, but is less correct. Otherwise, the value, if
      specified, should be the name of a hash object in <a href=
      "https://docs.python.org/2/library/hashlib.html">Python's hashlib</a>,
      such as <kbd>md5</kbd> (default), <kbd>sha1</kbd>, etc. In this mode, the
      application will use the checksum (based on the specified hashing method)
      of the content of each source file to determine if it has changed or
      not.</dd>
    </dl>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
# General settings
[arch]
command-format=foo put %(target)s %(sources)s
source-prefix=$ROSE_DATAC/
target-prefix=foo://hello/

# Archive a file to a file
[arch:world.out]
source=hello/world.out

# Auto gzip
[arch:planet.out.gz]
source=hello/planet.out

# Archive files matched by a glob to a directory
[arch:worlds/]
source=hello/worlds/*

# Archive multiple files matched by globs or names to a directory
[arch:worlds/]
source=hello/worlds/* greeting/worlds/* hi/worlds/*

# As above, but "greeting/worlds/*" may return an empty list
[arch:worlds/]
source=hello/worlds/* (greeting/worlds/*) hi/worlds/*

# Target is optional, implied that sources may all be missing
[arch:(black-box/)]
source=cats.txt dogs.txt

# Auto tar-gzip
[arch:galaxies.tar.gz]
source-prefix=hello/
source=galaxies/*
# File with multiple galaxies may be large, don't do its checksum
update-check=mtime+size

# Force gzip each source file
[arch:stars/]
source=stars/*
compress=gzip

# Source name transformation
[arch:moons.tar.gz]
source=moons/*
rename-format=%(cycle)s-%(name)s
source-edit-format=sed 's/Hello/Greet/g' %(in)s &gt;%(out)s

# Source name transformation with a rename-parser
[arch:unknown/stuff.pax]
rename-format=hello/%(cycle)s-%(name_head)s%(name_tail)s
rename-parser=^(?P&lt;name_head&gt;stuff)ing(?P&lt;name_tail&gt;-.*)$
source=stuffing-*.txt

# ...
</pre>

    <p>On completion, <code>rose_arch</code> writes a status summary for each
    target to the standard output, which looks like this:</p>

    <pre>
0 foo:///fred/my-su173/output0.tar.gz [compress=tar.gz]
+ foo:///fred/my-su173/output1.tar.gz [compress=tar.gz, t(init)=2012-12-02T20:02:20Z, dt(tran)=5s, dt(arch)=10s, ret-code=0]
+	output1/earth.txt (output1/human.txt)
+	output1/venus.txt (output1/woman.txt)
+	output1/mars.txt (output1/man.txt)
= foo:///fred/my-su173/output2.tar.gz [compress=tar.gz]
! foo:///fred/my-su173/output3.tar.gz [compress=tar.gz]
</pre>

    <p>The 1st column is a status symbol, where:</p>

    <dl>
      <dt>0</dt>
      <dd>An optional target has no real source, and is skipped</dd>

      <dt>+</dt>
      <dd>A target is added or updated.</dd>

      <dt>=</dt>
      <dd>A target is not updated, as it was previously successfully updated
      with the same sources.</dd>

      <dt>!</dt>
      <dd>Error updating this target.</dd>
    </dl>

    <p>If the 1st column and the 2nd column are separated by a space character,
    the 2nd column is a target. If the 1st column and the 2nd column are
    separated by a tab character, the 2nd column is a source in the target
    above.</p>

    <p>For a target line, the 3rd column contains the compress scheme, the
    initial time, the duration taken to transform the sources, the duration
    taken to run the archive command and the return code of the archive command.
    For a source line, the 3rd column contains the original name of the
    source.</p>

    <h2 id="rose-task-run.util.rose_bunch">Built-in Application:rose_bunch</h2>

    <p>This built-in application allows running of multiple command variants in
    parallel under a single job, as defined by the application
    configuration.</p>

    <p>The application is normally configured in the
    <kbd>[bunch]</kbd> and <kbd>[bunch-args]</kbd> sections in
    <var>rose-app.conf</var>.</p>

    <p>Each variant of the command is run in the same working directory with
    its output directed to separate <var>.out</var> and <var>.err</var> files
    of the form <var>bunch.&lt;name&gt;.out</var>. Should you need separate
    working directories you should configure your command to create the
    appropriate subdirectory for working in.</p>

    <p>Note that, under load balancing systems such as PBS or Slurm, you will
    need to set resource requests to reflect the resources required by running
    multiple commands at once e.g. if one command would require 1GB memory and
    you have configured your app to run up to 4 commands at once then you will
    need to request 4GB of memory.</p>

    <p>The following <kbd>[bunch]</kbd> settings are accepted:</p>

    <dl>
      <dt><kbd>command-format=FORMAT</kbd></dt>

      <dd>Compulsory. A Pythonic <code>printf</code> style format string to
      construct the commands to run. Insert placeholders <var>%(argname)s</var>
      for substitution of the arguments specified under <kbd>[bunch-args]</kbd>
      to the invoked command. The placeholder <var>%(instances)s</var> is
      reserved for inserting an automatically generated index for the command
      invocation when using the <kbd>instances</kbd> setting.</dd>

      <dt><kbd>command-instances=N</kbd></dt>

      <dd>Optional. Allows the user to specify an integer value for the number
      of instances of a command they want to run. This generates the values
      used by the <var>%(command-instances)s</var> value in
      <kbd>command-format</kbd>. Useful for cases where the only difference 
      between invocations would be an index number e.g. ensemble members. Note
      indexes start at <var>0</var>.</dd>

      <dt><kbd>pool-size=N</kbd></dt>

      <dd>Optional. Allows the user to limit the number of concurrently running
      commands. If not specified then all command variations will be run at
      the same time.</dd>

      <dt><kbd>fail-mode=continue|abort</kbd></dt>

      <dd>Optional (default=continue). Specify what action you want the job to
      take on the failure of a command that it is trying to run. If set to
      <var>continue</var> all command variants will be run by the job and the
      job will return a non-zero exit code upon completion e.g. if
      three commands are to be run and the second one fails, all three will be
      run and the job will exit with a return code of 1. Alternatively, if
      <var>fail-mode</var> is set to <var>abort</var> then on failure of any
      one of the command variants it will stop trying to run any further
      variants N.B. the job will wait for any already running commands to
      finish before exiting. Commands that won't be run due to aborting will be
      reported in the job output with a <var>[SKIP]</var> prefix when running
      in verbose mode. For example in the case of three command variants
      with a pool-size of 1 and <var>fail-mode=abort</var>, if the second
      variant failed then the job would exit with a non-zero error code without
      having run the third variant.</dd>

      <dt><kbd>incremental=true|false</kbd></dt>

      <dd>Optional (default=true). If set to <var>true</var> then only failed
      commands will be re-run on retrying running of the job. If any changes
      are made to the configuration being run then all variants will be re-run.
      Similarly, running the app with the <kbd>--new</kbd> option to <kbd>rose
      task-run</kbd> will result in all commands being run. In verbose mode the
      app will report commands that won't be run due to previous successes in
      the job output with a <var>[PASS]</var> prefix.</dd>

      <dt><kbd>names=name1 name2 ...</kbd></dt>

      <dd>Optional. Allows defining names for each of the command variants to
      be run, facilitating identification in logs. If not set then commands
      will be identified by their index. The number of entries in the names
      must be the same as the number of entries in each of the args to be
      used.</dd>

    </dl>

    <p>The <kbd>[bunch-args]</kbd> section is used to specify the various 
    combinations of args to be passed to the command specified under 
    <kbd>[bunch]command-format=</kbd>:</p>

    <dl>
      <dt><kbd>argname=val1 val2 ...</kbd></dt>

      <dd>Optional. Allows defining named lists of argument values to pass to
      <kbd>[bunch]command-format=</kbd>. Multiple named sets of
      arguments can be defined. Each <var>argname</var> can be referenced in
      the using <var>%(argname)s</var>. The only disallowed name is
      <var>instances</var>, which is reserved for the auto-generated list of
      instances when the <kbd>[bunch]instances=N</kbd> option is
      used.</dd>
    </dl>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
meta=rose_bunch
mode=rose_bunch

[bunch]
command-format=echo arg1: %(arg1)s, arg2: %(arg2)s, command-instance: %(command-instances)s
fail-handle = abort
incremental = True
instances = 4
limit=2
names = foo1 bar2 baz3 qux4

[bunch-args]
arg1=1 2 3 4
arg2=foo bar baz qux
</pre>

    <h2 id="rose-task-run.util.rose_prune">Built-in Application:
    rose_prune</h2>

    <p>This built-in application offers a way to housekeep a cycling suite. It
    prunes files and directories generated by suite tasks. It is designed to
    work under <code>rose task-run</code> on the host that runs the suite
    daemon.</p>

    <p>In automatic selection mode, this built-in application will be invoked
    automatically if a task has a name that starts with
    <code>rose_prune*</code>.</p>

    <p>The application is normally configured in the <kbd>[prune]</kbd> section
    in a <var>rose-app.conf</var>.</p>

    <p>All settings are expressed as a space delimited list of cycles, normally
    as cycle points or offsets relative to the current cycle. For date-time
    cycles, the format of a cycle point should be an ISO8601 date-time, and an
    offset should be an ISO8601 duration. E.g.  <kbd>-P1DT6H</kbd> is 1 day and
    6 hours before the current cycle point.</p>

    <p>The cycles of some settings also accept an optional argument followed by
    a colon. In these, the argument should be globs for matching items in the
    directory. If two or more globs are required, they should be separated by a
    space. In which case, either the argument should be quoted or the space
    should be escaped by a backslash.</p>

    <p>The following settings are accepted:</p>

    <dl>
      <dt><kbd>cycle-format{key}=format</kbd></dt>

      <dd>
        Specify a key to a format string for use in conjunction with a
        <kbd>prune{item-root}=cycle:globs ...</kbd> setting. For example, we may
        have something like <kbd>cycle-format{cycle_year}=CCYY</kbd> and
        <kbd>prune{share}=-P1Y:xmas-present-%(cycle_year)s/</kbd>. In cylc, if
        the current cycle point is 20151201T0000Z, it will clear out the
        directory <samp>share/xmas-present-2014/</samp>.
      
        <p>The <var>key</var> can be any string that can be used in a
        <code>%(key)s</code> substitution, and <var>format</var> should be a a
        valid <a href="rose-command.html#rose-date-print-format">rose date print
        format</a>.</p>
      </dd>

      <dt><kbd>prune-remote-logs-at=cycle ...</kbd></dt>

      <dd>Re-sync remote job logs at these cycles and remove them from remote
      hosts.</dd>

      <dt><kbd>prune-server-logs-at=cycle ...</kbd></dt>

      <dd>Remove logs on the suite server. Removes both log directories and
      archived logs.</dd>

      <dt><kbd>archive-logs-at=cycle ...</kbd></dt>

      <dd>Archive all job logs at these cycles. Remove remote job logs on
      success.</dd>

      <dt><kbd>prune{item-root}=cycle[:globs] ...</kbd></dt>

      <dd>
        Remove the sub-directories under <var>item-root</var> (e.g.
        <samp>work/</samp> of the specified cycles. E.g. In cylc, if current
        cycle is <samp>20141225T1200Z</samp>, <kbd>prune{work}=-PT12H</kbd> will
        clear out <var>work/20141225T0000Z/</var>.

        <p>If <var>globs</var> are specified for a cycle, it will attempt to
        prune only items matching <var>CYCLE/GLOBS</var> under
        <var>item-root</var>. E.g. In cylc, if current cycle is
        <samp>20141225T1200Z</samp>, then
        <kbd>prune{share/cycle}=-PT12H:wild*</kbd> will clear out all items
        matching <var>share/cycle/20141225T0000Z/wild*</var>.</p>

        <p>A glob can also be specified as a formatting string containing a
        single substitution <code>%(cycle)s</code>. In this mode, the cycle
        string will not be added as a sub-directory of the item-root. E.g. In
        cylc, if current cycle is <samp>20141225T1200Z</samp>, then
        <kbd>prune{share}=-PT12H:hello-*-at-%(cycle)s.txt</kbd> will clear
        out all items matching
        <var>share/hello-*-at-20141225T0000Z.txt</var>.</p>

        <p>A glob can also be specified as a formatting string containing a
        substitution <code>%(key)s</code>, if a
        <code>cycle-format{key}=format</code> setting is specified. See above
        for detail.</p> 
      </dd>

      <dt><em>Deprecated</em> <kbd>prune-work-at=cycle[:globs] ...</kbd></dt>

      <dd>Equivalent to <kbd>prune{work}=cycle[:globs] ...</kbd>.</dd>

      <dt><em>Deprecated</em> <kbd>prune-datac-at=cycle[:globs] ...</kbd></dt>

      <dd>Equivalent to <kbd>prune{share/cycle}=cycle[:globs] ...</kbd></dd>
    </dl>

    <p>E.g.:</p>
    <pre class="prettyprint lang-rose_conf">
meta=rose_prune
mode=rose_prune

[prune]
cycle-format{cycle_year_month}=CCYYMM
prune-remote-logs-at=-PT6H
archive-logs-at=-P1D
prune-server-logs-at=-P7D
prune{work}=-PT6H:task_x* -PT12H:*/other*.dat -PT18H:task_y* -PT24H
prune{share}=-P1D:hello-*-at-%(cycle)s.txt -P3M:monthly/%(cycle_year_month)s/
prune{share/cycle}=-PT6H:foo* -PT12H:'bar* *.baz*' -P1D
</pre>

    <h2 id="rose-task-env">rose task-env</h2>

    <p>There are times when extra environment needs to be defined before
    launching <code>rose task-run</code>. This is where <code>rose
    task-env</code> may come in handy. The command prints to the
    <var>STDOUT</var> the standard Rose task environment variables (which are
    normally provided by <code>rose task-run</code>) in a syntax compatible to
    <a href="http://www.gnu.org/software/bash/">bash</a> / <a href=
    "http://www.kornshell.com/">ksh</a>. This means that the output of this
    command can be shell <code>eval</code> into the current environment.
    E.g.</p>
    <pre class="shell">
eval $(rose task-env)
</pre>

    <p>See <a href="rose-command.html#rose-task-env">Rose Reference Guide: CLI
    &gt; rose task-env</a> for a full list of environment variables provided by
    this command.</p>

    <h2 id="rose-app-run">rose app-run</h2>

    <p>Run an application according to its configuration, outside of a suite
    task environment. Although you will normally launch a Rose application
    using <code>rose task-run</code>, there are situations when you may have a
    standalone Rose application configuration that you just want to run outside
    of a suite. This is where <code>rose app-run</code> may come in handy.</p>

    <p>See <a href="rose-command.html#rose-app-run">Rose Reference Guide: CLI
    &gt; rose app-run</a> for a full list of environment variables provided by
    this command.</p>
  </div>
</body>
</html>
